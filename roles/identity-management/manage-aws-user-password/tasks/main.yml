---

- name: "Process password for AWS user(s)"
  block:
    - name: Debug profile data
      debug:
        var: profile_data
    - name: Set initial password for AWS user
      command: "aws iam create-login-profile --profile {{ profile_data.profile_name }} --user-name {{ user_data.user_name }} --password {{ user_data.password }} --password-reset-required"
    - debug:
        msg:
          - "Username: {{ user_data.user_name }}"
          - "Password: {{ user_data.password }}"
          - "User must change password at next login."
      with_items:
        - "{{ identities.users }}"
      loop_control:
        loop_var: user_data
      when:
        - identities.users is defined
        - identities.users|length > 0
        - user_data.targets is undefined or
          'aws' in user_data.targets
        - user_data.password is defined
        - user_data.password|trim != ''
  when:
    - identities.targets is undefined or
      'aws' in identities.targets
